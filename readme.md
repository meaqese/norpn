# norpn

## Описание

Этот проект представляет собой 2 приложения (оркестратор (orch) и агент).

Оркестратор реализует http для вычисления арифметических выражений. Он принимает строковое арифметическое выражение в формате json через http post-запрос (и не только :), выполняет его вычисление и возвращает ID принятого выражения. С помощью этого ID можно получить результат.

Калькулятор поддерживает стандартные арифметические операции:
- Сложение (+)
- Вычитание (-)
- Умножение (*)
- Деление (/)

Поддерживаются круглые скобки для задания порядка выполнения операций, а так же скобки внутри скобок.

---

## Архитектура

```mermaid
graph TD
    U[Пользователь] -->|POST /api/v1/calculate| O[Оркестратор]
    U -->|GET /expressions| O
    U -->|POST /register | O
    U -->|POST /login | O
    A[Агенты] -->|gRPC getTask| O
    A -->|gRPC sendResult| O
```

---

## Установка и запуск

### Шаг 1: Клонировать репозиторий

Клонируем репу с гитхаба, переходим на склонированную папку и устанавливаем все нужные пакеты

```bash
git clone https://github.com/meaqese/norpn.git
cd norpn
go mod tidy
```

### Шаг 2: Запуск приложения

Для запуска выполните команды:

**Оркестратор**
```bash
go run ./cmd/orch
```

**Агент**
```bash
go run ./cmd/agent
```

_Да, на удивление здесь можно было и обойтись без Docker и Docker Compose (и даже без Kubernetes), меньше слоев, меньше памяти, меньше мусора. Совет работает только для данного случая._

>После запуска оркестратор будет доступен на порту `8080` по адресу: `http://localhost:8080`. 
>Порт можно менять в переменных окружения - `PORT`.

> Оркестратор так же принимает переменные окружения (по умолчанию везде `1000`)
> - `TIME_ADDITION_MS` - время выполнения операции сложения в миллисекундах
> - `TIME_SUBTRACTION_MS` - время выполнения операции вычитания в миллисекундах
> - `TIME_MULTIPLICATIONS_MS` - время выполнения операции умножения в миллисекундах
> - `TIME_DIVISIONS_MS` - время выполнения операции деления в миллисекундах

> `JWT_SECRET` - ключ от JWT

> Агент принимает переменную окружения COMPUTING_POWER и GRPC_PORT что указывает количеству воркеров, по умолчанию `1` и 
> порт оркестратора gRPC соответственно.  
---
## ~~Веб-интерфейс~~ Пока не работает

~~При запусуке оркестратора, по его адресу (по умолчанию `http://localhost:8080/`) доступен веб-интерфейс приложения, если адрес или порт
по умолчанию решили поменять, поменяйте и в `/web/main.js` константу `API_DOMAIN` для корректной работы.~~
___
## Описание API Оркестратора

>Если курл не сработал, можете попробовать экранировать кавычки, - `\"`, или лучше используйте Postman

### 1. `/api/v1/register`
**Метод**: POST
**Описание**: Принимает логин и пароль в формате JSON и регистрирует.

### Пример запроса:

```bash
curl -X POST http://localhost:8080/api/v1/register \
-H "Content-Type: application/json" \
-d '{"username": "123", "password": "123"}'
```

**Пример ответа (успешное выполнение - 200 OK):**

```json
{"status": true}
```

### 2. `/api/v1/login`
**Метод**: POST
**Описание**: Принимает логин и пароль в формате JSON и аутентифицирует.

### Пример запроса:

```bash
curl -X POST http://localhost:8080/api/v1/register \
-H "Content-Type: application/json" \
-d '{"username": "123", "password": "123"}'
```

**Пример ответа (успешное выполнение - 200 OK):**

```json
{"status": true, "jwt_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NDcwNzg4MjgsInN1YiI6Mn0.uwYFT1eShO7vEkMgD0e2xmx3Wqcw86aVckVnps7ufeo"}
```

**Пример ответа (вход с некорректными данными - 401 Unauthorized):**

```json
{"status": false, "error": "invalid credentials"}
```


### 3. `/api/v1/calculate`

**Метод:** POST

**Описание:** Принимает арифметическое выражение в JSON формате, выполняет вычисления и возвращает результат.

### Пример запроса:

```bash
curl -X POST http://localhost:8080/api/v1/calculate \
-H "Content-Type: application/json" \
-H "Authorization: Bearer <тут токен который вы получаете после аутентификации>" \
-d '{"expression": "(2+2)*2"}'
```

**Пример ответа (успешное выполнение - 201 Created):**

```json
{"id":1}
```

### 4. `/api/v1/expressions`

**Метод:** GET

**Описание:** Возвращает список вычисляемых/вычисленных выражений.

#### Пример запроса:

```bash
curl http://localhost:8080/api/v1/expressions \ 
-H "Authorization: Bearer <тут токен который вы получаете после аутентификации>"
```

**Пример ответа (успешное выполнение):**

```json
{
  "expressions": [
    {
      "id": 1,
      "status": "completed",
      "result": 4
    },
    {
      "id": 2,
      "status": "completed",
      "result": 8
    },
    {
      "id": 3,
      "status": "error",
      "reason": "parsing error"
    }
  ]
}
```

### 5. `/api/v1/expressions/:id`

**Метод:** GET

**Описание:** Возвращает вычисляемое/вычисленное выражение.

#### Пример запроса:

```bash
curl http://localhost:8080/api/v1/expressions/5 \
-H "Authorization: Bearer <тут токен который вы получаете после аутентификации>" 
```

**Пример ответа (успешное выполнение):**

```json
{"id":5,"status":"completed","result":4}
```


> При успешном выполнении возвращается 200 код статуса

### Возможные ошибки
**1. Ошибка 401 (Unauthorized):**

Это ошибка возникает, если не передан JWT токен в заголовке Authorization

Пример запроса:

```bash
curl -X POST http://localhost:8080/api/v1/calculate \
-H "Content-Type: application/json" \
-d '{"expression": "2+x"}'
```

**2. Ошибка 403 (Forbidden):**

Это ошибка возникает, если например вы запросили Expression по ID, но это выражение не 
принадлежит вашему аккаунту


**3. Ошибка 422 (Unprocessable Entity):**

Это ошибка возникает, если передано недопустимое выражение (например, если в нем присутствуют посторонние символы или есть синтаксическая ошибка).

Пример запроса:

```bash
curl -X POST http://localhost:8080/api/v1/calculate \
-H "Content-Type: application/json" \
-H "Authorization: Bearer <тут токен который вы получаете после аутентификации>" \
-d '{"expression": "2+x"}'
```

**4. Ошибка 404 (Not Found):**

Это ошибка возникает, если чего то запрашиваемого не существует, например если нет такого выражения.

Пример запроса:

```bash
curl http://localhost:8080/api/v1/expression/123132
```

**5. Ошибка 500 (Internal Server Error):**

Эта ошибка возникает, если произошло что-то непредвиденное при выполнении вычислений.

Ошибку возпроизвести не удалось, поскольку обрабатываются известные ошибки, но можете попытаться.

**6. Ошибки в процессе вычисления**

В данном случае, ошибка не возвращается с статус кодом, об этом пишется в теле ответа выражения, если 
`status` = `error`, то рядом с ней будет и `reason` где будет описана причина.

Пример ответа при делении на `0`:

```json
{"id":1,"status":"error","reason":"division to 0"}
```

---

### ~~Тесты~~ Не успел, завтра...

~~**Интеграционный тест всего проекта**~~
```bash
go test ./test
```

